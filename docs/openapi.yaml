openapi: 3.0.3
info:
  title: Notification API
  version: 1.0.0
servers:
  - url: /api/v1
security:
  - ApiKeyAuth: []
paths:
  /health:
    get:
      summary: Health check
      responses:
        '200':
          description: OK
        '503':
          description: Degraded
  /metrics:
    get:
      summary: Real-time metrics
      responses:
        '200':
          description: Metrics payload
          content:
            application/json:
              schema:
                type: object
                properties:
                  queues:
                    type: object
                  status_counts:
                    type: object
                  dead_letter_count:
                    type: integer
                  circuit_breaker:
                    type: object
                  avg_latency_seconds:
                    type: number
  /metrics/prometheus:
    get:
      summary: Prometheus metrics
      responses:
        '200':
          description: Metrics in Prometheus text format
          content:
            text/plain:
              schema:
                type: string
  /notifications:
    post:
      summary: Create notifications (batch or single)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateNotificationsRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateNotificationsResponse'
        '409':
          description: Idempotency conflict
    get:
      summary: List notifications
      parameters:
        - in: query
          name: status
          schema:
            type: string
        - in: query
          name: channel
          schema:
            type: string
        - in: query
          name: priority
          schema:
            type: string
        - in: query
          name: from
          schema:
            type: string
            format: date-time
        - in: query
          name: to
          schema:
            type: string
            format: date-time
        - in: query
          name: batch_id
          schema:
            type: string
            format: uuid
        - in: query
          name: page
          schema:
            type: integer
        - in: query
          name: per_page
          schema:
            type: integer
      responses:
        '200':
          description: Notification list
  /notifications/{notificationId}:
    get:
      summary: Get notification status
      parameters:
        - in: path
          name: notificationId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Notification status
  /notifications/{notificationId}/cancel:
    post:
      summary: Cancel a pending notification
      parameters:
        - in: path
          name: notificationId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Cancelled
        '409':
          description: Cannot cancel
  /batches/{batchId}:
    get:
      summary: Get batch status
      parameters:
        - in: path
          name: batchId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Batch status
  /batches/{batchId}/cancel:
    post:
      summary: Cancel a batch
      parameters:
        - in: path
          name: batchId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Cancelled
  /dead-letter:
    get:
      summary: List dead-letter notifications
      parameters:
        - in: query
          name: channel
          schema:
            type: string
        - in: query
          name: per_page
          schema:
            type: integer
      responses:
        '200':
          description: Dead-letter list
  /dead-letter/requeue:
    post:
      summary: Requeue multiple dead-letter notifications
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
        - in: query
          name: channel
          schema:
            type: string
        - in: query
          name: priority
          schema:
            type: string
            enum: [high, normal, low]
        - in: query
          name: delay_seconds
          schema:
            type: integer
      responses:
        '200':
          description: Requeue summary
  /dead-letter/{deadLetterId}:
    get:
      summary: Get a dead-letter notification by ID
      parameters:
        - in: path
          name: deadLetterId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Dead-letter item
  /dead-letter/{deadLetterId}/requeue:
    post:
      summary: Requeue a dead-letter notification
      parameters:
        - in: path
          name: deadLetterId
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: priority
          schema:
            type: string
            enum: [high, normal, low]
        - in: query
          name: delay_seconds
          schema:
            type: integer
      responses:
        '201':
          description: Requeued
        '422':
          description: Missing recipient or channel
  /templates:
    post:
      summary: Create a notification template
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, channel, content]
              properties:
                name:
                  type: string
                channel:
                  type: string
                  enum: [sms, email, push]
                content:
                  type: string
                default_variables:
                  type: object
      responses:
        '201':
          description: Template created
    get:
      summary: List templates
      parameters:
        - in: query
          name: per_page
          schema:
            type: integer
      responses:
        '200':
          description: Template list
  /templates/preview:
    post:
      summary: Preview a template with variables
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [template_id]
              properties:
                template_id:
                  type: string
                  format: uuid
                variables:
                  type: object
      responses:
        '200':
          description: Rendered template content
  /templates/{templateId}:
    get:
      summary: Get a template by ID
      parameters:
        - in: path
          name: templateId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Template item
    patch:
      summary: Update a template
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                channel:
                  type: string
                  enum: [sms, email, push]
                content:
                  type: string
                default_variables:
                  type: object
      responses:
        '200':
          description: Template updated
    delete:
      summary: Delete a template
      responses:
        '200':
          description: Template deleted
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-Api-Key
  schemas:
    CreateNotificationsRequest:
      type: object
      properties:
        batch:
          type: object
          properties:
            idempotency_key:
              type: string
            correlation_id:
              type: string
            metadata:
              type: object
        notifications:
          type: array
          minItems: 1
          maxItems: 1000
          items:
            type: object
            required: [recipient, channel]
            properties:
              recipient:
                type: string
              channel:
                type: string
                enum: [sms, email, push]
              priority:
                type: string
                enum: [high, normal, low]
              content:
                type: string
              template_id:
                type: string
                format: uuid
              variables:
                type: object
              idempotency_key:
                type: string
              correlation_id:
                type: string
              scheduled_at:
                type: string
                format: date-time
    CreateNotificationsResponse:
      type: object
      properties:
        batch_id:
          type: string
          format: uuid
        trace_id:
          type: string
        span_id:
          type: string
        metadata:
          type: object
        created:
          type: integer
        duplicates:
          type: integer
        notifications:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              batch_id:
                type: string
                format: uuid
              channel:
                type: string
              priority:
                type: string
              status:
                type: string
